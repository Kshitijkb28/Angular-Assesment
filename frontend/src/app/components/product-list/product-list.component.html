<div class="container">
  <div class="page-header">
    <h1>Product Management</h1>
    <p class="subtitle">Manage your product inventory</p>
  </div>

  <div *ngIf="error" class="alert alert-error">
    <strong>Error:</strong> {{ error }}
  </div>
  <div *ngIf="success" class="alert alert-success">
    <strong>Success:</strong> {{ success }}
  </div>

  <div class="action-bar">
    <div class="action-buttons">
      <button class="btn btn-primary" (click)="openModal()">
        Add Product
      </button>
      <button class="btn btn-success" (click)="openBulkUploadModal()">
        Bulk Upload
      </button>
    </div>
    <div class="report-buttons">
      <button class="btn btn-secondary" (click)="downloadReport('csv')">
        Download CSV
      </button>
      <button class="btn btn-secondary" (click)="downloadReport('xlsx')">
        Download XLSX
      </button>
    </div>
  </div>

  <div class="search-bar card">
    <div class="search-input-group">
      <input 
        type="text" 
        class="form-control search-input" 
        [(ngModel)]="searchTerm" 
        (keyup.enter)="onSearch()"
        placeholder="Search products by name...">
    </div>
    
    <select class="form-control category-select" [(ngModel)]="categoryFilter" (change)="onSearch()">
      <option value="">All Categories</option>
      <option *ngFor="let category of categories" [value]="category.id">
        {{ category.name }}
      </option>
    </select>

    <button class="btn btn-primary search-btn" (click)="onSearch()">
      Search
    </button>
  </div>

  <div *ngIf="loading" class="loading">Loading...</div>

  <div *ngIf="!loading" class="card">
    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>Image</th>
          <th>Product Name</th>
          <th (click)="onSort('price')" class="sortable">
            Price {{ sortBy === 'price' ? (sortOrder === 'asc' ? '↑' : '↓') : '⇅' }}
          </th>
          <th>Category</th>
          <th>Unique ID</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let product of products; let i = index">
          <td><strong>{{ (currentPage - 1) * pageSize + i + 1 }}</strong></td>
          <td>
            <div class="product-image-wrapper">
              <img *ngIf="product.image" 
                   [src]="'http://localhost:3000/uploads/' + product.image" 
                   alt="{{ product.name }}" 
                   class="product-image">
              <div *ngIf="!product.image" class="no-image">No Image</div>
            </div>
          </td>
          <td><strong>{{ product.name }}</strong></td>
          <td><span class="price-tag">${{ product.price }}</span></td>
          <td><span class="category-badge">{{ product.category?.name }}</span></td>
          <td><code class="unique-id">{{ product.uniqueId }}</code></td>
          <td>
            <div class="action-buttons">
              <button class="action-btn edit-btn" (click)="openModal(product)" title="Edit product">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Edit
              </button>
              <button class="action-btn delete-btn" (click)="deleteProduct(product.id)" title="Delete product">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
                Delete
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="pagination" *ngIf="totalPages > 1">
      <button (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1">
        Previous
      </button>
      <span>Page {{ currentPage }} of {{ totalPages }}</span>
      <button (click)="onPageChange(currentPage + 1)" [disabled]="currentPage === totalPages">
        Next
      </button>
    </div>
  </div>
</div>

<!-- Product Modal -->
<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <h2>{{ editingProduct ? 'Edit Product' : 'Add Product' }}</h2>
    
    <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
      <div class="form-group">
        <label>Product Name</label>
        <input type="text" class="form-control" formControlName="name" placeholder="Enter product name">
      </div>

      <div class="form-group">
        <label>Price</label>
        <input type="number" class="form-control" formControlName="price" placeholder="Enter price" step="0.01">
      </div>

      <div class="form-group">
        <label>Category</label>
        <select class="form-control" formControlName="categoryId">
          <option value="">Select category</option>
          <option *ngFor="let category of categories" [value]="category.id">
            {{ category.name }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>Image</label>
        <input type="file" class="form-control" (change)="onFileSelected($event)" accept="image/*">
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
        <button type="submit" class="btn btn-primary" [disabled]="productForm.invalid">
          {{ editingProduct ? 'Update' : 'Create' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Bulk Upload Modal -->
<div class="modal-overlay" *ngIf="showBulkUploadModal" (click)="closeBulkUploadModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <h2>Bulk Upload Products</h2>
    
    <div class="alert alert-info">
      <p><strong>Instructions:</strong></p>
      <ul>
        <li>Upload a CSV or XLSX file</li>
        <li>Required columns: name, price, categoryId</li>
        <li>Optional column: image</li>
      </ul>
    </div>

    <div class="form-group">
      <label>Select File</label>
      <input type="file" class="form-control" (change)="onBulkFileSelected($event)" 
             accept=".csv,.xlsx,.xls">
    </div>

    <div *ngIf="bulkUploadProgress" class="alert alert-info">
      {{ bulkUploadProgress }}
    </div>

    <div class="modal-actions">
      <button type="button" class="btn btn-secondary" (click)="closeBulkUploadModal()">Cancel</button>
      <button type="button" class="btn btn-primary" (click)="onBulkUpload()" 
              [disabled]="!bulkUploadFile || bulkUploadProgress">
        Upload
      </button>
    </div>
  </div>
</div>
